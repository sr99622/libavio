#!/bin/bash

/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
echo >> $HOME/.zprofile
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $HOME/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"
brew install wget automake nasm libtool pkgconfig

mkdir -p $HOME/ffmpeg_sources 
mkdir -p $HOME/bin
mkdir -p $HOME/sources
mkdir -p $HOME/libxml2_sources

export PKG_CONFIG_PATH=$HOME/ffmpeg_build/lib/pkgconfig
export SDL2_DIR=$HOME/ffmpeg_build
export LIBXML2_INCLUDE_DIRS=$HOME/libxml2_build/include/libxml2
export LIBXML2_LIBRARIES=$HOME/libxml2_build/lib/libxml2.dylib

cd scripts/mac

./build_cmake_mac
./build_h264
./build_h265
./fix_x265_rpath
./build_aac
./build_sdl2
./build_ffmpeg 

versions=("3.10.11" "3.11.9" "3.12.9" "3.13.2" "3.14.2")
for version in "${versions[@]}"; do
    ./install_python $version
done

cd ../..
first_pass=1
venvs=("py310" "py311" "py312" "py313" "py314")
for venv in "${venvs[@]}"; do
    source $HOME/$venv/bin/activate
    python --version
    pip install build
    if [ $first_pass == 1 ]; then
        pip install .
        pyname=$(ls $HOME/$venv/lib | awk '{print $1}')
        pydir=$HOME/$venv/lib/$pyname/site-packages
        modname=$(ls $pydir/avio/avio*.so | awk '{print $1}')
        export executable=$modname
        export sourcedir=avio
        scripts/mac/copy_libs
        scripts/mac/install_name
    fi
    first_pass=0
    python -m build .
    deactivate
done
